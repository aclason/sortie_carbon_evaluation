---
title: "SORTIE Carbon Extension Note"
author: "Alana Clason & Leah Walker"
date: "2022-08-29"
output: html_document
editor_options: 
  chunk_output_type: console
---

Load libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

ls <- c("tidyverse", "data.table") # Data Management and Manipulation (removed plyr - might need to add back)
ls <- append(ls, c("rsortie")) # sortie
ls <- append(ls, c("lme4", "lmerTest", "Rmisc")) # analysis
ls <- append(ls, c("DateCreekData","SummitLakeData")) #data wrangling packages 
ls <- append(ls, c("treeCalcs","sortieCarbon")) #package for allometry and carbon calculations
ls <- append(ls, c("terra","sf")) #spatial data
#ls <- append(ls, "doParallel")
# Install if needed -- then load. 
new.packages <- ls[!(ls %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(ls, library, character.only = TRUE)  # load the required packages
rm(ls, new.packages)


```




3. Downed wood Figures
```{r}
#SBS
MS_cwd_sl
FS_cwd_sl

ggplot(MS_cwd_sl, aes(x=timestep, y = MgHa, group=unit, colour = treatment))+
  geom_line(linewidth=1)+
  stat_summary(geom = "ribbon", fun.min = min, fun.max = max, alpha = 0.1) +
  #stat_summary(geom = "line", fun = mean)
  theme_minimal()
ggsave(filename = "DecayRates_SBS.jpg",path = "./Outputs/Figures/", device='jpeg', dpi=1000, bg="white")

#Volume  
ggplot(NULL)+
  geom_jitter(data = FS_cwd_sl, aes(x= timestep, y = VolHa, colour = treatment))+
  geom_line(data = MS_cwd_sl, aes(x=timestep, y = VolHa, 
                                  group = unit, colour = treatment), linetype = 1)
  #geom_point(data = FS_cwd_dc, aes(x= Yrs_Post, y = VolHa, colour = Treatment))
  
geom_jitter(data = FS_cwd_sl_s, aes(x=timestep, y = VolHa, colour = treatment),
              size = 1, shape = 2)

#Carbon 
ggplot(NULL)+
  geom_jitter(data = FS_cwd_sl, aes(x= timestep, y = MgHa, colour = treatment))+
  geom_line(data = MS_cwd_sl, aes(x=timestep, y = MgHa, 
                                  group = unit, colour = treatment), linetype = 1)#
  #geom_point(data = FS_cwd_dc, aes(x= Yrs_Post, y = MgHa, colour = Treatment))


  geom_jitter(data = FS_cwd_sl_s, aes(x=timestep, y = MgHa, colour = treatment),
              size = 1, shape = 2)


MS_cwd_sl <- cwdc_sm[,.(MgHa = mean(MgHa),
                        VolHa = mean(values)), by = c("treatment","unit","timestep","DecayClass")]

ggplot(MS_cwd_sl)+
  geom_line(aes(x=timestep, y = MgHa, group=unit, colour = treatment))+
  facet_wrap(~as.factor(DecayClass))
ggsave(filename = "DecayRates_SBS.jpg",path = "./Outputs/Figures/", device='jpeg', dpi=1000, bg="white")

#ICH -------------------------------------------------------------------------------
# Modelled:
#By pixel id - summ all the decay class volumes and carbon together
M_cwd_dc <- cwdc_dc[,.(pixMgHa = sum(MgHa), pixVolHa = sum(values)),
                       by = c("Treatment","Unit","timestep","ID")]
#Add then take the average value across the whole unit
MS_cwd_dc <- M_cwd_dc[,.(MgHa = mean(pixMgHa), VolHa = mean(pixVolHa)),
                       by = c("Treatment","Unit","timestep")]


#MS_cwd_dc[, Yrs_Post:= as.numeric(timestep)]
setnames(MS_cwd_dc, "timestep", "Yrs_Post")

ggplot(MS_cwd_dc)+
  geom_line(aes(x=Yrs_Post, y = MgHa, group = Unit, colour = Treatment))



#MS_cwd_dc <- cwdc_dc[,.(MgHa = mean(MgHa), VolHa = mean(values)),
 #                      by = c("Treatment","Unit","timestep","DecayClass")]

```


3. Snags recruitment, snag fall and snag longevity calculations

very few snags are recruiting (<1% across treatments)
```{r}
#08-SnagFall.R
sl_ad_sn_sp
setnames(sl_ad_sn_sp, c("unit","treatment"),c("Unit","Treatment"))
sl_ad_sn
setnames(sl_ad_sn, c("unit","treatment"),c("Unit","Treatment"))
sl_snag_time
setnames(sl_snag_time, c("unit","treatment"),c("Unit","Treatment"))

#note - these won't start at time 0 as only years with snags recruited or fall are included
dc_ad_sn_sp
dc_ad_sn


# stats:
library(betareg)
library(lmtest)
sl_ad_sn_sp[, .(mean(SnagRecrRate), mean(SnagFallRate)), by = "Treatment"]

mod1 <- betareg(SnagRecrRate ~ Treatment + timestep, data = sl_ad_sn)
null_mod <- betareg(SnagRecrRate ~ 1, data = sl_ad_sn)
lr_test <- lrtest(null_mod, mod1)
summary(mod1)

summary(betareg(SnagFallRate ~ Treatment * timestep, data = sl_ad_sn_sp))


# Figures:
ggplot(dc_ad_sn)+
  geom_point(aes(x = timestep, y = SnagRecrRate, colour = as.character(Unit)),size=4)+
  geom_line(aes(x = timestep, y = SnagRecrRate, colour = as.character(Unit)),size=1.5)+
  theme_minimal()+
  ylab("Snag Recruitment (adults - snags) Rate (%)")
ggsave("D:/Github/sortie_carbonExtensionNote/Outputs/Figures/SnagRecruitRate_newCM.jpg")

ggplot()+
  #geom_point(aes(x = timestep, y = SnagRecrRate, colour = as.character(Unit)),size=2, data = dc_ad_sn)+
  #geom_line(aes(x = timestep, y = SnagRecrRate, colour = as.character(Unit)),size=1, data = dc_ad_sn)+
  geom_point(aes(x = timestep, y = SnagRecrRate, colour = as.character(Treatment)),size=2, data = sl_ad_sn)+
  geom_smooth(aes(x = timestep, y = SnagRecrRate, colour = as.character(Treatment)),size=1, data = sl_ad_sn)+
  theme_minimal()+
  ylab("Snag Recruitment (adults - snags) Rate (%)")


ggplot(NH_ad_sn_sp)+
  geom_point(aes(x = timestep, y = SnagRecrRate, colour = Species),size=4)+
  #geom_smooth(aes(x = timestep, y = SnagRecrRate, colour = Species))+
  geom_line(aes(x = timestep, y = SnagRecrRate, colour = Species),size=0.5)+
  scale_colour_manual(values = brewer.pal(9, "Set3"))+
  theme_minimal()+
  ylab("Snag Recruitment (adults - snags) Rate (%)")+
  facet_wrap("Unit")


ggplot(dc_ad_sn)+
  geom_point(aes(x = timestep, y = SnagRecrRate, colour = Treatment),size=4)+
  #geom_line(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=1.5)+
  geom_smooth(aes(x = timestep, y = SnagRecrRate, colour = Treatment),size=1.5,
              method = "lm")+
  theme_minimal()+
  ylab("Snag Recruitment (adults - snags) Rate (%)")

#which trees are dying
ggplot(dc_ad_sn_sp)+
  geom_point(aes(x = timestep, y = SnagRecrRate, colour = Treatment))+
  #geom_line(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=1.5)+
  geom_smooth(aes(x = timestep, y = SnagRecrRate, colour = Treatment),
              method = "lm")+
  theme_minimal()+
  facet_wrap("Species")+
  ylab("Snag Recruitment (adults - snags) Rate (%)")


ggplot(dc_ad_sn)+
  geom_point(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=4)+
  #geom_line(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=1.5)+
  geom_smooth(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=1.5,
              method = "lm")+
  theme_minimal()+
  ylab("Snag Fall Rate (snags - snag fall) (%)")
#ggsave("D:/Github/sortie_carbonExtensionNote/Outputs/Figures/SnagFallRate_newSnagDyn.jpg")

ggplot(sl_ad_sn[timestep<30])+
  geom_point(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=4)+
  #geom_line(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=1.5)+
  geom_smooth(aes(x = timestep, y = SnagFallRate, colour = Treatment),size=1.5,
              method = "lm")+
  theme_minimal()+
  ylab("Snag Fall Rate (snags - snag fall) (%)")

ggplot(sl_ad_sn_sp)+
  geom_point(aes(x = timestep, y = SnagFallRate, colour = Species),size=4)+
  #geom_smooth(aes(x = timestep, y = SnagFallRate))+
  #geom_line(aes(x = timestep, y = SnagFallRate, colour = Species),size=0.5)+
  scale_colour_manual(values = RColorBrewer::brewer.pal(4, "Set3"))+
  theme_minimal()+
  ylab("Snag Fall Rate (snags - snag fall) Rate (%)")+
  facet_wrap("Treatment")

ggplot()+
  geom_point(aes(x = timestep, y = SnagFallRate, colour = as.character(Unit)),size=2, data = dc_ad_sn)+
  #geom_line(aes(x = timestep, y = SnagFallRate, colour = as.character(Unit)),size=1, data = dc_ad_sn)+
  geom_point(aes(x = timestep, y = SnagFallRate, colour = as.character(Unit)),size=2, data = sl_ad_sn)+
  #geom_line(aes(x = timestep, y = SnagFallRate, colour = as.character(Unit)),size=1, data = sl_ad_sn)+
  geom_smooth(aes(x = timestep, y = SnagFallRate),size=2, colour = "red", data = dc_ad_sn)+
  geom_smooth(aes(x = timestep, y = SnagFallRate),size=2, colour = "blue", data = sl_ad_sn)+
  theme_minimal()+
  ylab("Snag Fall Rate (snags - snag fall) Rate (%)")


ggplot(sl_snag_time)+
  geom_boxplot(aes(y = Unit, x = TimeAsSnag, fill = Unit))+
  theme_minimal()+
  ylab("Number of years standing as snag")+
  facet_wrap("Species")
ggsave("D:/Github/sortie_carbonExtensionNote/Outputs/Figures/SnagLongevity.jpg")

ggplot(sl_snag_time)+
  geom_boxplot(aes(y = as.character(Species), x = TimeAsSnag, fill =Species))+
  theme_minimal()+
  ylab("Number of years standing as snag")
  facet_wrap("Species")
ggsave("D:/Github/sortie_carbonExtensionNote/Outputs/Figures/SnagLongevity.jpg")


#from SORTIE parameters: 
# tree fall probability (never becomes a snag)


#Check against the snag run:
unique(NH_tr[Type=="Adult"]$Dead.Code) # no adults were assigned a dead code of natural (or harvest)

```



ggplot(MS_cwd_sl, aes(x=timestep, y = MgHa, group=unit, colour = treatment))+
  geom_line(linewidth=1)+
  stat_summary(geom = "ribbon", fun.min = min, fun.max = max, alpha = 0.1) +
  #stat_summary(geom = "line", fun = mean)
  theme_minimal()
ggsave(filename = "DecayRates_SBS.jpg",path = "./Outputs/Figures/", device='jpeg', dpi=1000, bg="white")

#Volume  
ggplot(NULL)+
  geom_jitter(data = FS_cwd_sl, aes(x= timestep, y = VolHa, colour = treatment))+
  geom_line(data = MS_cwd_sl, aes(x=timestep, y = VolHa, 
                                  group = unit, colour = treatment), linetype = 1)
  #geom_point(data = FS_cwd_dc, aes(x= Yrs_Post, y = VolHa, colour = Treatment))
  
geom_jitter(data = FS_cwd_sl_s, aes(x=timestep, y = VolHa, colour = treatment),
              size = 1, shape = 2)

#Carbon 
ggplot(NULL)+
  geom_jitter(data = FS_cwd_sl, aes(x= timestep, y = MgHa, colour = treatment))+
  geom_line(data = MS_cwd_sl, aes(x=timestep, y = MgHa, 
                                  group = unit, colour = treatment), linetype = 1)#
  #geom_point(data = FS_cwd_dc, aes(x= Yrs_Post, y = MgHa, colour = Treatment))


  geom_jitter(data = FS_cwd_sl_s, aes(x=timestep, y = MgHa, colour = treatment),
              size = 1, shape = 2)


MS_cwd_sl <- cwdc_sm[,.(MgHa = mean(MgHa),
                        VolHa = mean(values)), by = c("treatment","unit","timestep","DecayClass")]

ggplot(MS_cwd_sl)+
  geom_line(aes(x=timestep, y = MgHa, group=unit, colour = treatment))+
  facet_wrap(~as.factor(DecayClass))
ggsave(filename = "DecayRates_SBS.jpg",path = "./Outputs/Figures/", device='jpeg', dpi=1000, bg="white")

#ICH -------------------------------------------------------------------------------
# Modelled:
#By pixel id - summ all the decay class volumes and carbon together
M_cwd_dc <- cwdc_dc[,.(pixMgHa = sum(MgHa), pixVolHa = sum(values)),
                       by = c("Treatment","Unit","timestep","ID")]
#Add then take the average value across the whole unit
MS_cwd_dc <- M_cwd_dc[,.(MgHa = mean(pixMgHa), VolHa = mean(pixVolHa)),
                       by = c("Treatment","Unit","timestep")]


#MS_cwd_dc[, Yrs_Post:= as.numeric(timestep)]
setnames(MS_cwd_dc, "timestep", "Yrs_Post")

ggplot(MS_cwd_dc)+
  geom_line(aes(x=Yrs_Post, y = MgHa, group = Unit, colour = Treatment))



#MS_cwd_dc <- cwdc_dc[,.(MgHa = mean(MgHa), VolHa = mean(values)),
 #                      by = c("Treatment","Unit","timestep","DecayClass")]

```

#MS_cwd_dc[, Yrs_Post := timestep][,timestep:=NULL]

ggplot(MS_cwd_dc)+
  geom_line(aes(x=timestep, y = MgHa, group = Unit, colour = Unit))+
  facet_wrap(~as.factor(DecayClass))


# Field:
#summarize by unit - only works if not including decay and species:
#F_cwd_dc[,.(plotVol = mean(VolumeHa), plotMg = mean(MgHa)), by = .(Unit, Year, Treatment)]

#update Yrs post:
F_cwd_dc[, Yrs_Post:= ifelse(Year == 1992,0,
                       ifelse(Year == 1993, 1,
                        ifelse(Year == 2011, 19, 27)))]

#when including species decay, need to get the plot totals, then means then sum of means
# sum all the piece volumes and carbon by plot
plotTots <- F_cwd_dc[, .(plotVol = sum(VolumeHa), plotMg = sum(MgHa)),
           by = .(Treatment, Unit, Year, Yrs_Post, Sp, Decay, Unique_plot)]

# take the mean vol and mg by species decay class and year across plots for each unit
FS_cwd_dc_sp_d <- plotTots[, .(VolHa = mean(plotVol), MgHa = mean(plotMg)),
                           by = .(Treatment, Unit, Year, Yrs_Post, Sp, Decay)]

#if you want the overall volume of MgHa, then sum all the average values together by unit
FS_cwd_dc <- FS_cwd_dc_sp_d[, .(VolHa = sum(VolHa), MgHa = sum(MgHa)),
                 by = .(Treatment, Unit, Year, Yrs_Post)]

ggplot(FS_cwd_dc)+
  geom_line(aes(x=Yrs_Post, y = VolHa, group = Unit, colour = Treatment))



# Field vs. Modelled
ggplot(NULL)+
  geom_line(data = MS_cwd_dc, aes(x= Yrs_Post, y = VolHa, 
                                  group = Unit, colour = Treatment), linetype = 2, linewidth = 1)+
  geom_point(data = FS_cwd_dc, aes(x=Yrs_Post, y = VolHa, 
                                  group = Unit, colour = Treatment))


ggplot(NULL)+
  geom_line(data = MS_cwd_dc, aes(x= Yrs_Post, y = MgHa, 
                                  group = Unit, colour = Unit), linetype = 1, linewidth = 2)+
  geom_point(data = FS_cwd_dc, aes(x=Yrs_Post, y = MgHa, 
                                  group = Unit, colour = Unit))


ggplot(NULL, aes(x = timestep,  y = C_unit, fill = Treatment, group = Treatment)) + 
  geom_line(data = DC_L_C_u_T, aes(col = Treatment), size = 1.2) + 
  theme(axis.line = element_line(colour = "black"), 
        panel.background = element_blank(), 
        legend.position = "top", 
        legend.text = element_text(size = 25),
        text = element_text(size = 28),
        axis.text = element_text(size = 23),
        axis.text.x = element_text(vjust = -1),
        axis.text.y = element_text(hjust = 0.5),
        axis.ticks.length = unit(7, "pt"),
        axis.title.x = element_text(margin = margin(t = 14,  r = 0, b = 1, l = 0), face = "bold"),
        axis.title.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(0, 26, by = 2), expand = expansion(mult = c(0, 0.05))) +
  scale_y_continuous(breaks = seq(0, 325, by = 50), limits = c(-1, 325)) +
  ylab("Live carbon Mg/ha") + 
  xlab('Years post-treatment') +
  geom_ribbon(data = DC_L_C_u_T, aes(ymin = C_unit - ci, ymax = C_unit + ci),  
              alpha=0.1, linetype="dashed",  color="grey") +
  geom_point(data = DC_field_L_C_T, aes(shape = Treatment), size = 3 , 
             position = position_dodge(width = 0.5)) +
  scale_shape_manual(values = c(24, 21, 23, 22)) +
  geom_errorbar(data = DC_field_L_C_T, aes(ymin = C_unit - ci, ymax = C_unit + ci), 
                position = position_dodge(width = 1))

```


From SORTIE
```{r}

######### Date Creek -----------------------------------------------------------------------
Outputs_path <-  "../SORTIEparams/Outputs/ICH/JuvGrowth/" #update this to the latest run path
out_name <- "L-sn_br.csv" #update this to the latest run naming convention
outputs <- list.files(path_outputs, pattern = out_name,full.names = TRUE)

#create a single csv file for each plot from sortie outputs
#for Date Creek the outputs are processed through the subplot function
dc_sortie <- calcSortieC(outputs = outputs, dead = TRUE, BEC = "ICH")
fwrite(dc_sortie, "./Inputs/Data/DC_sortieC.csv")  

M_cwd_dc
F_cwd_dc

#make rasters only for the grids of interest
grid_to_output <- "totallogvol"

#need to put the coordinates in the crs of date creek
for(i in 1:length(DateCreekData::Treatments$Unit)){
  UnitBounds_l <- UnitBounds %>% filter(Unit== DateCreekData::Treatments$Unit[i])
  bb <- st_bbox(UnitBounds_l)
  g_dt[Unit==DateCreekData::Treatments$Unit[i],
       ':='(x_utm = ifelse(colnames == "GLI", bb[1]+(x*2), bb[1]+(x*8)),
            y_utm = ifelse(colnames == "GLI", bb[2]+(y*2), bb[2]+(y*8)))] 
}
g_dt[,':='(x = NULL, y = NULL)]
setnames(g_dt, c("x_utm","y_utm"), c("x","y"))

rast_i <- g_dt[colnames == grid_to_output] %>%
      arrange(.$timestep) %>%
      split(.$Unit) %>%
      lapply(., function(x) {x <- x %>% dplyr::select(-c("Unit","point_id","Unit",
                                                         "mapnm","colnames","V1","Treat"))}) %>%
      lapply(., function(x) {x <- x %>% pivot_wider(names_from = timestep, 
                                                    values_from = values)}) %>%
      map(.,rast)#%>%

#I give up using apply:
for(i in 1:length(rast_i)){
  Unit_i <- DateCreekData::Treatments$Unit[i]
  crs(rast_i[[Unit_i]]) <- "EPSG:3005"
  UnitBounds_l <- UnitBounds %>% filter(Unit== Unit_i)
  rast_i[[Unit_i]] <- mask(rast_i[[Unit_i]], UnitBounds_l)
}

#light grids --------------------------------------------------------------------------------
grid_to_output <- "QuadratGLI"

rast_gli <- g_dt[mapnm == grid_to_output] %>%
      arrange(.$timestep) %>%
      split(.$Unit) %>%
      lapply(., function(x) {x <- x %>% dplyr::select(-c("Unit","point_id","Unit",
                                                         "mapnm","colnames","V1","Treat"))}) %>%
      lapply(., function(x) {x <- x %>% pivot_wider(names_from = timestep, 
                                                    values_from = values)}) 
rast_gli
  pmap(rast_gli, rast)
  map(rast_gli, rast(x,crs, res)(., crs="EPSG:3153", res = 8))
  
  rast(rast_gli$A1, crs = "EPSG:3153")

#mask by the unit boundary
Units_path <- "../DateCreekData/data-raw/Harvests_Plants/UnitBoundaries/"
UnitBounds <- ReadSpatialBounds(Units_path = Units_path)

terra::crs(rast_gli$A1) <- terra::crs(UnitBounds %>% filter(Unit== "A1"))
mask(rast_gli$A1, UnitBounds %>% filter(Unit== "A1"))

#plot the rasters
gplot(rast_gli$D2) + 
  geom_tile(aes(fill = value)) +
  facet_wrap(~ variable) #+
  scale_fill_gradient(low = 'black', high = 'yellow') 

#-----------------------------------------------------------------------------------
#clip by unit boundaries

Units_path <- "../DateCreekData/data-raw/Harvests_Plants/UnitBoundaries/"
Gaps_path <- "..//DateCreekData/data-raw/Harvests_Plants/GapCutsDateCreek/"
UnitBounds <- ReadSpatialBounds(Units_path = Units_path)
HR_gaps <- modifyPartCuts(Gaps_path = Gaps_path)

#log volume:
logvol <- SampleDateCreekGrids(Blocks = Blocks, UnitBounds = UnitBounds, HR_gaps = HR_gaps,
                     sampl_rast = "Y", NoCells_ToSample = 40)
#Add treatment
logvol <- merge(logvol, DateCreekData::Treatments, by= "Unit")

logvolmin_max <- logvol[,.(volMin= min(totallogvol), volMax=max(totallogvol),
                           volMn=mean(totallogvol),volSd=sd(totallogvol)),
                        by=c("Unit","Treatment", "timestep")]

#field data -------------------------------------------------------------------------
data_loc <- "D:/Github/DateCreekData/data-raw/CWD/"
#run function for all years of volume:

cwd_all <- CWD_vol_calc(dat_loc = data_loc, incl_sp_decay = TRUE)
cwd_all <- merge(cwd_all, DateCreekData::Treatments, by="Unit")

#clean the cwd data to make it compatible with carbon function
#clean Species data
cwd_all[,Sp:= ifelse(Sp=="","U",
                ifelse(Sp=="u","U",
                  ifelse(Sp=="Act","Ac",
                    ifelse(Sp=="ep","Ep",
                      Sp))))]

#clean decay class data
cwd_all[, Decay:= ifelse(Decay==1.5,2,
                    ifelse(Decay==2.5,3,
                      ifelse(Decay==3.5,4,
                        ifelse(Decay==4.5,5,
                               Decay))))]


#apply the carbon function (need new species added)
cwd_all[, cwdCarbonCalc(VolumeHa,Decay,Sp), by=seq_len(nrow(cwd_all))] #not working

ggplot(cwd_all)+
  #geom_point(aes(colour = factor(Treatment), shape = factor(Treatment)), size = 2)+
  geom_point(aes(x = Yrs_Post,  y = VolumeHa, colour = Treatment))+
  facet_wrap(~Treatment)+
  geom_line(aes(x=Yrs_Post, y = VolumeHa, group=Unit, colour=Treatment))
#good enough for now ???


ggplot(cwd_all)+
  geom_boxplot(aes(x = as.factor(Yrs_Post),  y = VolumeHa, colour = Treatment))+
  facet_wrap(~Treatment)

ggplot()+
  geom_boxplot(data = cwd_all,
               aes(x = as.factor(Yrs_Post),  y = VolumeHa, colour = Treatment))+
  #geom_boxplot(data = logvol[timestep == "0"|timestep == "1"|timestep == "19"|timestep =="27"],
   #            aes(x = timestep, y = totallogvol, colour = Treatment))+
  facet_wrap(~Treatment)


cwd_all_summary <- cwd_all[,.(volMn = mean(VolumeHa),
                              volSd = sd(VolumeHa)),by=c("Unit","Yrs_Post","Treatment")]

ggplot()+
  #geom_point(aes(colour = factor(Treatment), shape = factor(Treatment)), size = 2)+
  geom_point(data = cwd_all_summary, aes(x = Yrs_Post,  y = volMn, colour = Unit),size=2)+
  #geom_ribbon(data = logvolmin_max, aes(x = as.numeric(timestep), ymin = volMin, 
   #                                     ymax =volMax, group=Unit, fill=Unit,
    #                                    alpha =0.1))+
  geom_line(data=logvolmin_max, aes(x=as.numeric(as.character(timestep)),y=volMn, colour = Unit),size=1)+
  facet_wrap(~Treatment)
  

#test the impact of using different sample sizes
logvol_sizeTest <- c(10,20,40,50,100) %>%
                      map(~ SampleDateCreekGrids(Blocks = Blocks, 
                                                 UnitBounds = UnitBounds, HR_gaps = HR_gaps,
                     sampl_rast = "Y", NoCells_ToSample = .x))
logvol_ST <- lapply(logvol_sizeTest,function(dt){merge(dt, Unit_treatment, by= "Unit")})

#take the mean of each unit/timestep
logvol_mn <- lapply(logvol_ST, function(dt) {dt[, mean(totallogvol), by=.(Unit,timestep,Treatment)]})
logvol_mn <- lapply(logvol_mn, function(dt)setnames(dt,"V1","mn_logVol"))

ggplot()+
  geom_point(data = cwd_all_summary, aes(x = Yrs_Post,  y = volMn, colour = Unit),size=2)+
  geom_line(data=logvol_mn[[4]], aes(x=as.numeric(as.character(timestep)),y=mn_logVol, colour = Unit),size=2)+
  facet_wrap(~Treatment)




ggplot(DC_L_C_u_mod, aes(x = field, y = sortie, shape = Treatment, color = Treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(Treatment), shape = factor(Treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 300, by = 50), limits = c(0, 310)) +
  scale_y_continuous(breaks = seq(0, 300, by = 50), limits = c(0, 310)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(17, 16, 18, 15),
                     breaks = c("CC", "HR", "LR", "NH"), 
                     labels = c("CC", "HR", "LR", "NH")) +
  scale_colour_manual(values = c("#F8766D", "#00BFC4", "#7CAE00", "#C77CFF"), 
                      breaks = c("CC", "HR", "LR", "NH"), 
                      labels = c("CC", "HR", "LR", "NH"))


######## Summit Lake ------------------------------------------------------------------------
path_outputs <- "D:/Github/sortie_carbonExtensionNote/Inputs/SORTIEruns/SummitLake/Outputs/extracted/"
run_name <- "-0506"

#create a single csv file for each plot from sortie outputs:
rdSortieOutputs(out_path = path_outputs,run_name = run_name)

outputs <- grep(".csv",
                list.files(path_outputs, pattern = run_name, full.names = TRUE),
                value = TRUE)







sl_sortie <- calcSortieC(outputs = outputs, dead = TRUE, BEC = "SBS")

treatsplit <- str_split(str_split(sl_sortie$Plot,"-", simplify=TRUE)[,3],
                        "t",simplify=TRUE)[,2]
sl_sortie[,Unit := as.numeric(treatsplit)]





```




















2. Estimate carbon from SORTIE by tree type (alive,snag), plot, timestep 
```{r}
sl_sortie <- fread("./Inputs/Data/SL_sortieC.csv")
dc_sortie <- fread("./Inputs/Data/DC_sortieC.csv")

#Take out seedlings
sl_sortie <- sl_sortie[Type != "Seedling"]
dc_sortie <- dc_sortie[Type != "Seedling"]

#### Summit Lake----------------------------------------------------------------------------- 
sl_sortie[,TSH:=ifelse(Unit==4|Unit==15,timestep+3,
                            timestep+1)]

sl_u <- sl_sortie[,.(C_Unit_Ha = sum(C_tree, na.rm=TRUE)/4), by=.(Unit,TSH,Type,Species)]
# For Summit Lake - full model runs = 200 x200m = 4 ha, so just applied it directly

#add treatment codes:
sl_u <- merge(sl_u, SummitLakeData::Treatments, by.x ="Unit", by.y = "unit")
sl_u[,LiveDead:=ifelse(Type=="Snag","Snag","Live")]
setnames(sl_u,"treatment","Treatment")
sl_u[,Study:="Summit Lake"]


#### Date Creek -----------------------------------------------------------------------------
dc_sortie[,TSH:=timestep-1]
# Sum carbon by Unit, plot, timestep, type (live, snag) and species
dc_p <- dc_sortie[, .(C_plot= sum(C_tree, na.rm=TRUE)), by=.(Unit,SubPlot,TSH,Type, Species)]
# Count the number of plots per unit and add to data set - varies by unit
Unit_plots <- dc_p[TSH == -1, .(NumPlots = length(unique(SubPlot))), by = Unit]

#Sum by unit and type and species
dc_u <- dc_p[, .(C_Unit = sum(C_plot, na.rm = TRUE)), by = .(Unit, TSH,Type,Species)]

dc_u <- merge(dc_u, Unit_plots, by = "Unit")
dc_u[, PlotArea := 0.02*NumPlots]

# Tree carbon by unit, timestep and Carbon (Mg)/Ha:
dc_u[, C_Unit_Ha := C_Unit/PlotArea, by =.(Unit, TSH,Type,Species)]

#add treatment codes:
dc_u <- merge(dc_u, DateCreekData::Treatments, by.x ="Unit", by.y = "Unit")
dc_u[,LiveDead:=ifelse(Type=="Snag","Snag","Live")][,NumPlots:=NULL][,PlotArea:=NULL][,C_Unit:=NULL]
dc_u[,Study:="Date Creek"]

#### Combine -------------------------------------------------------------------------------
#combine sortie runs together
dc_sl <- rbind(dc_u,sl_u)

#### Plot/summarize -------------------------------------------------------------------------------
#by species and type
ggplot(dc_u) +
  geom_point(aes(x = TSH, y = C_Unit_Ha, colour = Treatment))+
  facet_grid(c("Type","Species"))
  
#by unit and live/dead
dc_u_sum <- dc_u[,.(C_Unit_Ha = sum(C_Unit_Ha)), by=.(Unit,TSH,LiveDead,Treatment)]
sl_u_sum <- sl_u[,.(C_Unit_Ha = sum(C_Unit_Ha)), by=.(Unit,TSH,LiveDead,Treatment)]
dc_sl_sum <- dc_sl[,.(C_Unit_Ha = sum(C_Unit_Ha)), by=.(Study,Unit,TSH,LiveDead,Treatment)]


ggplot(dc_sl_sum[TSH>0]) +
  #geom_point(aes(x = timestep, y = C_Unit_Ha, colour = Treatment))+
  geom_line(aes(x = TSH, y = C_Unit_Ha, colour = Treatment, group=Unit))+
  geom_line(aes(x = TSH, y = C_Unit_Ha, colour = Treatment, group=Unit))+
  xlab("Time since harvest")+
  facet_grid(c("Study","LiveDead"))


ggsave("D:/Github/sortie_carbonExtensionNote/Outputs/Figures/CarbonLiveSnags.jpg")



```




2. Read in data

```{r}
###################
### Summit Lake ###
###################

### Field ###
# LIVE
SL_field_L_C <- read.csv("./Inputs/Data/SummitLake_C_field_L.csv") # SL = Summit Lake, L = living, C = carbon

# Live - Hybrid Spruce (Sx)
SL_field_L_C_Sx <- read.csv("./Inputs/Data/SummitLake_C_field_L_Sx.csv")

# Live - Subalpine fir (Bl)
SL_field_L_C_Bl <- read.csv("./Inputs/Data/SummitLake_C_field_L_Bl.csv")



# DEAD
SL_field_D_C <- read.csv("./Inputs/Data/SummitLake_C_field_D.csv") # D = dead



### Sortie ###

#LIVE
SL_L_C <- read.csv("./Inputs/Data/SummitLake_C_0506_L.csv")
# This data frame will be used below to calculate carbon per species

SL_L_C_u <- SL_L_C %>% # u = unit (this data frame is summarized to the unit level)
  dplyr::select(unit, timestep, C_unit, treatment)

SL_L_C_u <- as.data.table(unique(SL_L_C_u))



# DEAD
SL_D_C <- read.csv("./Inputs/Data/SummitLake_C_0506_D.csv")

SL_D_C_u <- SL_D_C %>%
  dplyr::select(unit, timestep, C_unit, treatment)

SL_D_C_u <- as.data.table(unique(SL_D_C_u))



##################
### Date Creek ###
##################

### Field ###
# LIVE
DC_field_L_C <- read.csv("./Inputs/Data/DateCreek_C_field_L.csv") # DC = Date Creek, L = living, C = carbon

# Live - Western red cedar (Cw)
DC_field_L_C_Cw <- read.csv("./Inputs/Data/DateCreek_C_field_L_Cw.csv")

# Live - Western hemlock (Hw)
DC_field_L_C_Hw <- read.csv("./Inputs/Data/DateCreek_C_field_L_Hw.csv")



# DEAD
DC_field_D_C <- read.csv( "./Inputs/Data/DateCreek_C_field_D.csv")



### Sortie ###

# LIVE
DC_L_C <- read.csv("./Inputs/Data/DateCreek_C_L.csv") # DC = Date Creek, L = living, C = carbon
# This data frame will be used below to calculate carbon per species

DC_L_C_p <- DC_L_C %>% # p = plot (this data frame is summarized to the plot level)
  dplyr::select(timestep, Unit, PlotNumber, C_plot, Treatment, count) 

DC_L_C_p <- unique(DC_L_C_p)

DC_L_C_p <- DC_L_C_p %>% 
  dplyr::group_by(timestep, Unit) %>% 
  dplyr::mutate(C_unit = sum(C_plot, na.rm = TRUE)/count)

DC_L_C_u <- DC_L_C_p %>% # u = unit
  dplyr::select(timestep, Unit, C_unit, Treatment) 

DC_L_C_u <- as.data.table(unique(DC_L_C_u))



# DEAD
DC_D_C <- read.csv("./Inputs/Data/DateCreek_C_D.csv")

DC_D_C_p <- DC_D_C %>% # p = plot (this data frame is summarized to the plot level)
  dplyr::select(timestep, Unit, PlotNumber, C_plot, Treatment, count) 

DC_D_C_p <- unique(DC_D_C_p)

DC_D_C_p <- DC_D_C_p %>% 
  dplyr::group_by(timestep, Unit) %>% 
  dplyr::mutate(C_unit = sum(C_plot, na.rm = TRUE)/count)

DC_D_C_u <- DC_D_C_p %>% # u = unit
  dplyr::select(timestep, Unit, C_unit, Treatment) 

DC_D_C_u <- as.data.table(unique(DC_D_C_u))

```



3. Live standing carbon
```{r}
###################
### Summit Lake ###
###################

### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - LIVE ONLY
final_SL_L_C_u <- as.data.table(subset(SL_L_C_u, timestep == 27))

final_SL_field_L_C <- subset(SL_field_L_C, timestep == 27)

final_SL_L_C_u <- merge(final_SL_L_C_u, final_SL_field_L_C, by = c("unit", "treatment", "timestep"))
names(final_SL_L_C_u)[names(final_SL_L_C_u) == "C_unit.x"] <- "C_unit"
names(final_SL_L_C_u)[names(final_SL_L_C_u) == "C_unit.y"] <- "field_C"

SL_L_rss <- with(final_SL_L_C_u, sum((C_unit - field_C)^2))
SL_L_rmse <- with(final_SL_L_C_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
SL_L_C_u_mod <- subset(SL_L_C_u, timestep == 0 | timestep ==  2 | timestep == 5 | timestep == 17 | timestep == 27) # mod = model

SL_L_C_u_mod <- merge(SL_L_C_u_mod, SL_field_L_C, by = c("unit", "treatment", "timestep")) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 - we don't want them to be zeros, they just weren't measured

names(SL_L_C_u_mod)[names(SL_L_C_u_mod) == "C_unit.x"] <- "sortie"
names(SL_L_C_u_mod)[names(SL_L_C_u_mod) == "C_unit.y"] <- "field"

SL_L_C_u_mod2 <- melt(SL_L_C_u_mod, id.vars = c("unit", "treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(SL_L_C_u_mod2)[names(SL_L_C_u_mod2) == "variable"] <- "DataSource"
names(SL_L_C_u_mod2)[names(SL_L_C_u_mod2) == "value"] <- "C_unit"

SL_L_C_u_mod2 <- SL_L_C_u_mod2 %>%
  mutate(unit = as.character(unit))

# Basic linear model
SL_L_C_lm <- lm(C_unit ~ DataSource, SL_L_C_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(SL_L_C_lm)

# Mixed effects models
SL_L_C_lmer <- lmer(C_unit ~ DataSource * treatment + (1|unit/timestep), SL_L_C_u_mod2)
summary(SL_L_C_lmer)



# Plot all timesteps at once - observed vs. predicted
png("./Figures/SL_alltime_L_C.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(SL_L_C_u_mod, aes(x = field, y = sortie, shape = treatment, color = treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(treatment), shape = factor(treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 120, by = 10), limits = c(0, 120)) +
  scale_y_continuous(breaks = seq(0, 120, by = 10), limits = c(0, 120)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(16, 15, 17),
                     breaks = c("ctrl", "med", "low"), 
                     labels = c("Control", "Medium retention", "Low retention")) +
  scale_colour_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention"))

dev.off()



# Plot carbon over time by treatment
SL_field_L_C_T <- summarySE(SL_field_L_C,
                      measurevar="C_unit",
                      groupvars=c("treatment", "timestep")) # T = treatment (this new data frame is summarized to the treatment level)

SL_field_L_C_T$N <- NULL

SL_L_C_u_T <- summarySE(SL_L_C_u,
                      measurevar="C_unit",
                      groupvars=c("treatment", "timestep"))

SL_L_C_u_T$N <- NULL

png("./Figures/SL_L_C_T.png", width=1600, height=800, units="px",
    pointsize=23, antialias="default")

ggplot(NULL, aes(x = timestep,  y = C_unit, fill = treatment, group = treatment)) + 
  geom_line(data = SL_L_C_u_T, aes(col = treatment), size = 1.2) + 
  theme(axis.line = element_line(colour = "black"), 
        panel.background = element_blank(), 
        legend.position = "top", 
        legend.text = element_text(size = 25),
        text = element_text(size = 28),
        axis.text = element_text(size = 23),
        axis.text.x = element_text(vjust = -1),
        axis.text.y = element_text(hjust = 0.5),
        axis.ticks.length = unit(7, "pt"),
        axis.title.x = element_text(margin = margin(t = 14,  r = 0, b = 1, l = 0), face = "bold"),
        axis.title.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(0, 28, by = 2), expand = expansion(mult = c(0, 0.05))) +
  scale_y_continuous(breaks = seq(0, 120, by = 20), expand = c(0,0), limits = c(0,120)) +
  scale_colour_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention")) +
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention")) +
  coord_cartesian(ylim = c(0, 120)) +
  labs(x = "Years post treatment", y = "Carbon (Mg/ha)", col = "Treatment", fill = "Treatment", shape = "Treatment") +
  geom_ribbon(data = SL_L_C_u_T, aes(ymin = C_unit - ci, ymax = C_unit + ci),  alpha=0.1, linetype="dashed",  color="grey") +
  geom_point(data = SL_field_L_C_T, aes(shape = treatment), size = 5 , position = position_dodge(width = 0.5)) +
  scale_shape_manual(values = c(24, 23, 21),
                     breaks = c("ctrl", "med", "low"), 
                     labels = c("Control", "Medium retention", "Low retention")) +
  geom_errorbar(data = SL_field_L_C_T, aes(ymin = C_unit - ci, ymax = C_unit + ci), position = position_dodge(width = 1)) 
  
dev.off()




##################
### Date Creek ###
##################

# Merge data frame with labels, so all timesteps have a C_unit (to include zeros) - e.g., the clear cut units

DC.labels.treatment <- unique(subset(DC_L_C_u, select = c("Unit", "Treatment")))

DC.labels.time <- data.frame(Unit = c(rep("A1", 27), rep("A2", 27), rep("A3", 27), rep("A4", 27), rep("B1", 27), rep("B2", 27), rep("B3", 27), rep("B4", 27), rep("B5", 27), rep("C1", 27), rep("C2", 27), rep("C3", 27), rep("D2", 27), rep("D3", 27), rep("D4", 27), rep("D5", 27)), timestep = rep(seq(0, 26, by = 1), times = 16))

DC.labels <- merge(DC.labels.treatment, DC.labels.time, by = "Unit")

DC_L_C_u <- merge(DC_L_C_u, DC.labels, by = c("Unit", "timestep"), all.y = TRUE)

DC_L_C_u$Treatment.x <- NULL

names(DC_L_C_u)[names(DC_L_C_u) == "Treatment.y"] <- "Treatment"

DC_L_C_u <- DC_L_C_u %>%
    dplyr::mutate(C_unit = replace(C_unit, is.na(C_unit), 0))



### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - LIVE ONLY
final_DC_L_C_u <- as.data.table(subset(DC_L_C_u, timestep == 26))

final_DC_field_L_C <- subset(DC_field_L_C, timestep == 26)

final_DC_L_C_u <- merge(final_DC_L_C_u, final_DC_field_L_C, by = c("Unit", "Treatment", "timestep"))
names(final_DC_L_C_u)[names(final_DC_L_C_u) == "C_unit.x"] <- "C_unit"
names(final_DC_L_C_u)[names(final_DC_L_C_u) == "C_unit.y"] <- "field_C"

DC_L_rss <- with(final_DC_L_C_u, sum((C_unit - field_C)^2))
DC_L_rmse <- with(final_DC_L_C_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
DC_L_C_u_mod <- subset(DC_L_C_u, timestep == 0 | timestep ==  1 | timestep == 18 | timestep == 26) # mod = model

DC_L_C_u_mod <- merge(DC_L_C_u_mod, DC_field_L_C, by = c("Unit", "Treatment", "timestep")) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 - we don't want them to be zeros, they just weren't measured

names(DC_L_C_u_mod)[names(DC_L_C_u_mod) == "C_unit.x"] <- "sortie"
names(DC_L_C_u_mod)[names(DC_L_C_u_mod) == "C_unit.y"] <- "field"

DC_L_C_u_mod2 <- melt(DC_L_C_u_mod, id.vars = c("Unit", "Treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(DC_L_C_u_mod2)[names(DC_L_C_u_mod2) == "variable"] <- "DataSource"
names(DC_L_C_u_mod2)[names(DC_L_C_u_mod2) == "value"] <- "C_unit"

DC_L_C_u_mod2 <- DC_L_C_u_mod2 %>%
  mutate(unit = as.character(Unit))

# Basic linear model
DC_L_C_lm <- lm(C_unit ~ DataSource, DC_L_C_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(DC_L_C_lm)

# Mixed effects models
DC_L_C_lmer <- lmer(C_unit ~ DataSource * Treatment + (1|Unit/timestep), DC_L_C_u_mod2) # Gets singular warning!!! Needs adjusting - LW (sept12 22)
summary(DC_L_C_lmer)



# Plot all timesteps at once - observed vs. predicted
png("./Figures/DC_alltime_L_C.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(DC_L_C_u_mod, aes(x = field, y = sortie, shape = Treatment, color = Treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(Treatment), shape = factor(Treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 300, by = 50), limits = c(0, 310)) +
  scale_y_continuous(breaks = seq(0, 300, by = 50), limits = c(0, 310)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(17, 16, 18, 15),
                     breaks = c("CC", "HR", "LR", "NH"), 
                     labels = c("CC", "HR", "LR", "NH")) +
  scale_colour_manual(values = c("#F8766D", "#00BFC4", "#7CAE00", "#C77CFF"), 
                      breaks = c("CC", "HR", "LR", "NH"), 
                      labels = c("CC", "HR", "LR", "NH"))

dev.off()



# Plot carbon over time by treatment
DC_field_L_C_T <- summarySE(DC_field_L_C,
                      measurevar="C_unit",
                      groupvars=c("Treatment", "timestep")) # T = treatment (this new data frame is summarized to the treatment level)

DC_field_L_C_T$N <- NULL

DC_L_C_u_T <- summarySE(DC_L_C_u,
                      measurevar="C_unit",
                      groupvars=c("Treatment", "timestep"))

DC_L_C_u_T$N <- NULL


png("./Figures/DC_L_C_T.png", width=1600, height=800, units="px",
    pointsize=23, antialias="default")

ggplot(NULL, aes(x = timestep,  y = C_unit, fill = Treatment, group = Treatment)) + 
  geom_line(data = DC_L_C_u_T, aes(col = Treatment), size = 1.2) + 
  theme(axis.line = element_line(colour = "black"), 
        panel.background = element_blank(), 
        legend.position = "top", 
        legend.text = element_text(size = 25),
        text = element_text(size = 28),
        axis.text = element_text(size = 23),
        axis.text.x = element_text(vjust = -1),
        axis.text.y = element_text(hjust = 0.5),
        axis.ticks.length = unit(7, "pt"),
        axis.title.x = element_text(margin = margin(t = 14,  r = 0, b = 1, l = 0), face = "bold"),
        axis.title.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(0, 26, by = 2), expand = expansion(mult = c(0, 0.05))) +
  scale_y_continuous(breaks = seq(0, 325, by = 50), limits = c(-1, 325)) +
  ylab("Live carbon Mg/ha") + 
  xlab('Years post-treatment') +
  geom_ribbon(data = DC_L_C_u_T, aes(ymin = C_unit - ci, ymax = C_unit + ci),  
              alpha=0.1, linetype="dashed",  color="grey") +
  geom_point(data = DC_field_L_C_T, aes(shape = Treatment), size = 3 , 
             position = position_dodge(width = 0.5)) +
  scale_shape_manual(values = c(24, 21, 23, 22)) +
  geom_errorbar(data = DC_field_L_C_T, aes(ymin = C_unit - ci, ymax = C_unit + ci), 
                position = position_dodge(width = 1)) 
  
dev.off()

```



4. Dead standing carbon
```{r}
###################
### Summit Lake ###
###################

# Merge data frame with labels, so all timesteps have a C_unit (to include zeros)

SL.labels.treatment <- unique(subset(SL_D_C_u, select = c("unit", "treatment")))

SL.labels.time <- data.frame(unit = c(rep(3, 28), rep(4, 28), rep(5, 28), rep(6, 28), rep(7, 28), rep(8, 28), rep(9, 28), rep(10, 28), rep(11, 28), rep(12, 28), rep(13, 28), rep(14, 28), rep(15, 28), rep(16, 28), rep(17, 28), rep(18, 28), rep(19, 28), rep(20, 28), rep(24, 28)), timestep = rep(seq(0, 27, by = 1), times = 19))

SL.labels <- merge(SL.labels.treatment, SL.labels.time, by = "unit")

SL_D_C_u <- merge(SL_D_C_u, SL.labels, by = c("unit", "timestep"), all.y = TRUE)

SL_D_C_u$treatment.x <- NULL

names(SL_D_C_u)[names(SL_D_C_u) == "treatment.y"] <- "treatment"

SL_D_C_u <- SL_D_C_u %>%
    dplyr::mutate(C_unit = replace(C_unit, is.na(C_unit), 0))



### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - DEAD ONLY
final_SL_D_C_u <- as.data.table(subset(SL_D_C_u, timestep == 27))

final_SL_field_D_C <- subset(SL_field_D_C, timestep == 27)

final_SL_D_C_u <- merge(final_SL_D_C_u, final_SL_field_D_C, by = c("unit", "treatment", "timestep"))
names(final_SL_D_C_u)[names(final_SL_D_C_u) == "C_unit.x"] <- "C_unit"
names(final_SL_D_C_u)[names(final_SL_D_C_u) == "C_unit.y"] <- "field_C"

SL_D_rss <- with(final_SL_D_C_u, sum((C_unit - field_C)^2))
SL_D_rmse <- with(final_SL_D_C_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
SL_D_C_u_mod <- subset(SL_D_C_u, timestep == 0 | timestep ==  2 | timestep == 5 | timestep == 17 | timestep == 27)

SL_D_C_u_mod <- merge(SL_D_C_u_mod, SL_field_D_C, by = c("unit", "treatment", "timestep")) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 
names(SL_D_C_u_mod)[names(SL_D_C_u_mod) == "C_unit.x"] <- "sortie"
names(SL_D_C_u_mod)[names(SL_D_C_u_mod) == "C_unit.y"] <- "field"

SL_D_C_u_mod2 <- melt(SL_D_C_u_mod, id.vars = c("unit", "treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(SL_D_C_u_mod2)[names(SL_D_C_u_mod2) == "variable"] <- "DataSource"
names(SL_D_C_u_mod2)[names(SL_D_C_u_mod2) == "value"] <- "C_unit"

SL_D_C_u_mod2 <- SL_D_C_u_mod2 %>%
  mutate(unit = as.character(unit))

# Basic linear model
SL_D_C_lm <- lm(C_unit ~ DataSource, SL_D_C_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(SL_D_C_lm)

# Mixed effects models
SL_D_C_lmer <- lmer(C_unit ~ DataSource * treatment + (1|unit/timestep), SL_D_C_u_mod2)
summary(SL_D_C_lmer)



# Plot all timesteps at once
png("./Figures/SL_alltime_D_C.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(SL_D_C_u_mod, aes(x = field, y = sortie, shape = treatment, color = treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(treatment), shape = factor(treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 35, by = 5), limits = c(0, 35)) +
  scale_y_continuous(breaks = seq(0, 35, by = 5), limits = c(0, 35)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(16, 15, 17),
                     breaks = c("ctrl", "med", "low"), 
                     labels = c("Control", "Medium retention", "Low retention")) +
  scale_colour_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention"))

dev.off()



# Plot carbon over time by treatment
SL_field_D_C_T <- summarySE(SL_field_D_C,
                      measurevar="C_unit",
                      groupvars=c("treatment", "timestep"))

SL_field_D_C_T$N <- NULL

SL_D_C_u_T <- summarySE(SL_D_C_u,
                      measurevar="C_unit",
                      groupvars=c("treatment", "timestep"))

SL_D_C_u_T$N <- NULL

png("./Figures/SL_D_C_T.png", width=1600, height=800, units="px",
    pointsize=23, antialias="default")

ggplot(NULL, aes(x = timestep,  y = C_unit, fill = treatment, group = treatment)) + 
  geom_line(data = SL_D_C_u_T, aes(col = treatment), size = 1.2) + 
  theme(axis.line = element_line(colour = "black"), 
        panel.background = element_blank(), 
        legend.position = "top", 
        legend.text = element_text(size = 25),
        text = element_text(size = 28),
        axis.text = element_text(size = 23),
        axis.text.x = element_text(vjust = -1),
        axis.text.y = element_text(hjust = 0.5),
        axis.ticks.length = unit(7, "pt"),
        axis.title.x = element_text(margin = margin(t = 14,  r = 0, b = 1, l = 0), face = "bold"),
        axis.title.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(0, 28, by = 2), expand = expansion(mult = c(0, 0.05))) +
  scale_y_continuous(breaks = seq(-10, 25, by = 5), expand = c(0,0), limits = c(-10, 25)) +
  scale_colour_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention")) +
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention")) +
  coord_cartesian(ylim = c(0, 25)) +
  labs(x = "Years post treatment", y = "Carbon (Mg/ha)", col = "Treatment", fill = "Treatment", shape = "Treatment") +
  geom_ribbon(data = SL_D_C_u_T, aes(ymin = C_unit - ci, ymax = C_unit + ci),  alpha=0.1, linetype="dashed",  color="grey") +
  geom_point(data = SL_field_D_C_T, aes(shape = treatment), size = 5 , position = position_dodge(width = 0.5)) +
  scale_shape_manual(values = c(24, 23, 21),
                     breaks = c("ctrl", "med", "low"), 
                     labels = c("Control", "Medium retention", "Low retention")) +
  geom_errorbar(data = SL_field_D_C_T, aes(ymin = C_unit - ci, ymax = C_unit + ci), position = position_dodge(width = 1)) 
  
dev.off()



##################
### Date Creek ###
##################

# Merge data frame with labels, so all timesteps have a C_unit (to include zeros) - e.g., the clear cut units

DC.labels.treatment <- unique(subset(DC_L_C_u, select = c("Unit", "Treatment")))

DC.labels.time <- data.frame(Unit = c(rep("A1", 27), rep("A2", 27), rep("A3", 27), rep("A4", 27), rep("B1", 27), rep("B2", 27), rep("B3", 27), rep("B4", 27), rep("B5", 27), rep("C1", 27), rep("C2", 27), rep("C3", 27), rep("D2", 27), rep("D3", 27), rep("D4", 27), rep("D5", 27)), timestep = rep(seq(0, 26, by = 1), times = 16))

DC.labels <- merge(DC.labels.treatment, DC.labels.time, by = "Unit")

DC_D_C_u <- merge(DC_D_C_u, DC.labels, by = c("Unit", "timestep"), all.y = TRUE)

DC_D_C_u$Treatment.x <- NULL

names(DC_D_C_u)[names(DC_D_C_u) == "Treatment.y"] <- "Treatment"

DC_D_C_u <- DC_D_C_u %>%
    dplyr::mutate(C_unit = replace(C_unit, is.na(C_unit), 0))



### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - LIVE ONLY
final_DC_D_C_u <- as.data.table(subset(DC_D_C_u, timestep == 26))

final_DC_field_D_C <- subset(DC_field_D_C, timestep == 26)

final_DC_D_C_u <- merge(final_DC_D_C_u, final_DC_field_D_C, by = c("Unit", "Treatment", "timestep"))
names(final_DC_D_C_u)[names(final_DC_D_C_u) == "C_unit.x"] <- "C_unit"
names(final_DC_D_C_u)[names(final_DC_D_C_u) == "C_unit.y"] <- "field_C"

DC_D_rss <- with(final_DC_D_C_u, sum((C_unit - field_C)^2))
DC_D_rmse <- with(final_DC_D_C_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
DC_D_C_u_mod <- subset(DC_D_C_u, timestep == 0 | timestep ==  1 | timestep == 18 | timestep == 26) # mod = model

DC_D_C_u_mod <- merge(DC_D_C_u_mod, DC_field_D_C, by = c("Unit", "Treatment", "timestep")) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 - we don't want them to be zeros, they just weren't measured

names(DC_D_C_u_mod)[names(DC_D_C_u_mod) == "C_unit.x"] <- "sortie"
names(DC_D_C_u_mod)[names(DC_D_C_u_mod) == "C_unit.y"] <- "field"

DC_D_C_u_mod2 <- melt(DC_D_C_u_mod, id.vars = c("Unit", "Treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(DC_D_C_u_mod2)[names(DC_D_C_u_mod2) == "variable"] <- "DataSource"
names(DC_D_C_u_mod2)[names(DC_D_C_u_mod2) == "value"] <- "C_unit"

DC_D_C_u_mod2 <- DC_D_C_u_mod2 %>%
  mutate(unit = as.character(Unit))

# Basic linear model
DC_D_C_Dm <- lm(C_unit ~ DataSource, DC_D_C_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(DC_D_C_Dm)

# Mixed effects models
DC_D_C_Dmer <- lmer(C_unit ~ DataSource * Treatment + (1|Unit/timestep), DC_D_C_u_mod2) # Gets singular warning!!! Needs adjusting - LW (sept12 22)
summary(DC_D_C_Dmer)



# Plot all timesteps at once - observed vs. predicted
png("./Figures/DC_alltime_D_C.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(DC_D_C_u_mod, aes(x = field, y = sortie, shape = Treatment, color = Treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(Treatment), shape = factor(Treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 60, by = 10), limits = c(0, 60)) +
  scale_y_continuous(breaks = seq(0, 60, by = 10), limits = c(0, 60)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(17, 16, 18, 15),
                     breaks = c("CC", "HR", "LR", "NH"), 
                     labels = c("CC", "HR", "LR", "NH")) +
  scale_colour_manual(values = c("#F8766D", "#00BFC4", "#7CAE00", "#C77CFF"), 
                      breaks = c("CC", "HR", "LR", "NH"), 
                      labels = c("CC", "HR", "LR", "NH"))

dev.off()



# Plot carbon over time by treatment
DC_field_D_C_T <- summarySE(DC_field_D_C,
                      measurevar="C_unit",
                      groupvars=c("Treatment", "timestep")) # T = treatment (this new data frame is summarized to the treatment level)

DC_field_D_C_T$N <- NULL

DC_D_C_u_T <- summarySE(DC_D_C_u,
                      measurevar="C_unit",
                      groupvars=c("Treatment", "timestep"))

DC_D_C_u_T$N <- NULL


png("./Figures/DC_D_C_T.png", width=1600, height=800, units="px",
    pointsize=23, antialias="default")

ggplot(NULL, aes(x = timestep,  y = C_unit, fill = Treatment, group = Treatment)) + 
  geom_line(data = DC_D_C_u_T, aes(col = Treatment), size = 1.2) + 
  theme(axis.line = element_line(colour = "black"), 
        panel.background = element_blank(), 
        legend.position = "top", 
        legend.text = element_text(size = 25),
        text = element_text(size = 28),
        axis.text = element_text(size = 23),
        axis.text.x = element_text(vjust = -1),
        axis.text.y = element_text(hjust = 0.5),
        axis.ticks.length = unit(7, "pt"),
        axis.title.x = element_text(margin = margin(t = 14,  r = 0, b = 1, l = 0), face = "bold"),
        axis.title.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(0, 26, by = 2), expand = expansion(mult = c(0, 0.05))) +
  scale_y_continuous(breaks = seq(-15, 75, by = 15), expand = c(0,0), limits = c(-15, 75)) +
  coord_cartesian(ylim = c(0, 75)) + # Remove this line if you want it to plot into the negative
  ylab("Live carbon Mg/ha") + 
  xlab('Years post-treatment') +
  geom_ribbon(data = DC_D_C_u_T, aes(ymin = C_unit - ci, ymax = C_unit + ci),  
              alpha=0.1, linetype="dashed",  color="grey") +
  geom_point(data = DC_field_D_C_T, aes(shape = Treatment), size = 3 , 
             position = position_dodge(width = 0.5)) +
  scale_shape_manual(values = c(24, 21, 23, 22)) +
  geom_errorbar(data = DC_field_D_C_T, aes(ymin = C_unit - ci, ymax = C_unit + ci), 
                position = position_dodge(width = 1)) 
  
dev.off()

```



5. Carbon by species (LIVE ONLY)
```{r}
###################
### Summit Lake ###
###################

##### Interior spruce #####

# Subset for Spruce
SL_L_C_Sx <- subset(SL_L_C, SL_L_C$Species == "Sx")

# Recalculate C per unit for spruce only
SL_L_C_Sx <- SL_L_C_Sx %>% 
  dplyr::group_by(timestep, unit) %>% 
  dplyr::mutate(C_unit = sum(C_tree, na.rm = TRUE))

# Select desired columns
SL_L_C_Sx_u <- SL_L_C_Sx %>%
  dplyr::select(unit, timestep, C_unit, treatment)

SL_L_C_Sx_u <- as.data.table(unique(SL_L_C_Sx_u))



### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - LIVE ONLY
final_SL_L_C_Sx_u <- as.data.table(subset(SL_L_C_Sx_u, timestep == 27))

final_SL_field_L_C_Sx <- subset(SL_field_L_C_Sx, timestep == 27)

final_SL_L_C_Sx_u <- merge(final_SL_L_C_Sx_u, final_SL_field_L_C_Sx, by = c("unit", "treatment", "timestep"))
names(final_SL_L_C_Sx_u)[names(final_SL_L_C_Sx_u) == "C_unit.x"] <- "C_unit"
names(final_SL_L_C_Sx_u)[names(final_SL_L_C_Sx_u) == "C_unit.y"] <- "field_C"

SL_Sx_rss <- with(final_SL_L_C_Sx_u, sum((C_unit - field_C)^2))
SL_Sx_rmse <- with(final_SL_L_C_Sx_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
SL_L_C_Sx_u_mod <- subset(SL_L_C_Sx_u, timestep == 0 | timestep ==  2 | timestep == 5 | timestep == 17 | timestep == 27)

SL_L_C_Sx_u_mod <- merge(SL_L_C_Sx_u_mod, SL_field_L_C_Sx, by = c("unit", "treatment", "timestep")) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 

names(SL_L_C_Sx_u_mod)[names(SL_L_C_Sx_u_mod) == "C_unit.x"] <- "sortie"
names(SL_L_C_Sx_u_mod)[names(SL_L_C_Sx_u_mod) == "C_unit.y"] <- "field"

SL_L_C_Sx_u_mod2 <- melt(SL_L_C_Sx_u_mod, id.vars = c("unit", "treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(SL_L_C_Sx_u_mod2)[names(SL_L_C_Sx_u_mod2) == "variable"] <- "DataSource"
names(SL_L_C_Sx_u_mod2)[names(SL_L_C_Sx_u_mod2) == "value"] <- "C_unit"

SL_L_C_Sx_u_mod2 <- SL_L_C_Sx_u_mod2 %>%
  mutate(unit = as.character(unit))

# Basic linear model
SL_L_C_Sx_lm <- lm(C_unit ~ DataSource, SL_L_C_Sx_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(SL_L_C_Sx_lm)

# Mixed effects models
SL_L_C_Sx_lmer <- lmer(C_unit ~ DataSource * treatment + (1|unit/timestep), SL_L_C_Sx_u_mod2)
summary(SL_L_C_Sx_lmer)

# Plot all timesteps at once

png("./Figures/SL_alltime_L_C_Sx.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(SL_L_C_Sx_u_mod, aes(x = field, y = sortie, shape = treatment, color = treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(treatment), shape = factor(treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 60, by = 10), limits = c(0, 60)) +
  scale_y_continuous(breaks = seq(0, 60, by = 10), limits = c(0, 60)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(16, 15, 17),
                     breaks = c("ctrl", "med", "low"), 
                     labels = c("Control", "Medium retention", "Low retention")) +
  scale_colour_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention"))

dev.off()



##### Subalpine fir #####

# Subset for Fir
SL_L_C_Bl <- subset(SL_L_C, SL_L_C$Species == "Bl")

# Recalculate C per unit for spruce only
SL_L_C_Bl <- SL_L_C_Bl %>% 
  dplyr::group_by(timestep, unit) %>% 
  dplyr::mutate(C_unit = sum(C_tree, na.rm = TRUE))

# Select desired columns
SL_L_C_Bl_u <- SL_L_C_Bl %>%
  dplyr::select(unit, timestep, C_unit, treatment)

SL_L_C_Bl_u <- as.data.table(unique(SL_L_C_Bl_u))



### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - LIVE ONLY
final_SL_L_C_Bl_u <- as.data.table(subset(SL_L_C_Bl_u, timestep == 27))

final_SL_field_L_C_Bl <- subset(SL_field_L_C_Bl, timestep == 27)

final_SL_L_C_Bl_u <- merge(final_SL_L_C_Bl_u, final_SL_field_L_C_Bl, by = c("unit", "treatment", "timestep"))
names(final_SL_L_C_Bl_u)[names(final_SL_L_C_Bl_u) == "C_unit.x"] <- "C_unit"
names(final_SL_L_C_Bl_u)[names(final_SL_L_C_Bl_u) == "C_unit.y"] <- "field_C"

SL_Bl_rss <- with(final_SL_L_C_Bl_u, sum((C_unit - field_C)^2))
SL_Bl_rmse <- with(final_SL_L_C_Bl_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
SL_L_C_Bl_u_mod <- subset(SL_L_C_Bl_u, timestep == 0 | timestep ==  2 | timestep == 5 | timestep == 17 | timestep == 27)

SL_L_C_Bl_u_mod <- merge(SL_L_C_Bl_u_mod, SL_field_L_C_Bl, by = c("unit", "treatment", "timestep")) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 

names(SL_L_C_Bl_u_mod)[names(SL_L_C_Bl_u_mod) == "C_unit.x"] <- "sortie"
names(SL_L_C_Bl_u_mod)[names(SL_L_C_Bl_u_mod) == "C_unit.y"] <- "field"

SL_L_C_Bl_u_mod2 <- melt(SL_L_C_Bl_u_mod, id.vars = c("unit", "treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(SL_L_C_Bl_u_mod2)[names(SL_L_C_Bl_u_mod2) == "variable"] <- "DataSource"
names(SL_L_C_Bl_u_mod2)[names(SL_L_C_Bl_u_mod2) == "value"] <- "C_unit"

SL_L_C_Bl_u_mod2 <- SL_L_C_Bl_u_mod2 %>%
  mutate(unit = as.character(unit))

# Basic linear model
SL_L_C_Bl_lm <- lm(C_unit ~ DataSource, SL_L_C_Bl_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(SL_L_C_Bl_lm)

# Mixed effects models
SL_L_C_Bl_lmer <- lmer(C_unit ~ DataSource * treatment + (1|unit/timestep), SL_L_C_Bl_u_mod2)
summary(SL_L_C_Bl_lmer)

# Plot all timesteps at once

png("./Figures/SL_alltime_L_C_Bl.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(SL_L_C_Bl_u_mod, aes(x = field, y = sortie, shape = treatment, color = treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(treatment), shape = factor(treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 85, by = 10), limits = c(0, 85)) +
  scale_y_continuous(breaks = seq(0, 85, by = 10), limits = c(0, 85)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(16, 15, 17),
                     breaks = c("ctrl", "med", "low"), 
                     labels = c("Control", "Medium retention", "Low retention")) +
  scale_colour_manual(values = c("#F8766D", "#619CFF", "#00BA38"), 
                      breaks = c("ctrl", "med", "low"), 
                      labels = c("Control", "Medium retention", "Low retention"))

dev.off()



##################
### Date Creek ###
##################

##### Western redcedar #####

DC_L_C_Cw <- subset(DC_L_C, DC_L_C$Species == "Cw")

# Recalculate C per unit for cedar only
DC_L_C_Cw_p <- DC_L_C_Cw %>% 
  dplyr::group_by(timestep, Unit, PlotNumber) %>% 
  dplyr::mutate(C_plot = sum(C_tree, na.rm = TRUE))

# Select desired columns
DC_L_C_Cw_p <- DC_L_C_Cw_p %>% 
  dplyr::select(timestep, Unit, PlotNumber, C_plot, Treatment, count)

DC_L_C_Cw_p <- unique(DC_L_C_Cw_p)

# Calculate carbon per unit by averaging carbon per plot
DC_L_C_Cw_u <- DC_L_C_Cw_p %>% 
  dplyr::group_by(timestep, Unit) %>% 
  dplyr::mutate(C_unit = sum(C_plot, na.rm = TRUE)/count)

# Select desired columns
DC_L_C_Cw_u <- DC_L_C_Cw_u %>% 
  dplyr::select(timestep, Unit, C_unit, Treatment)

DC_L_C_Cw_u <- unique(DC_L_C_Cw_u)



# Merge with labels, so all timesteps have a C_unit (including zeros)
DC_L_C_Cw_u <- merge(DC_L_C_Cw_u, DC.labels, by = c("Unit", "timestep"), all.y = TRUE)

DC_L_C_Cw_u$Treatment.x <- NULL

names(DC_L_C_Cw_u)[names(DC_L_C_Cw_u) == "Treatment.y"] <- "Treatment"

DC_L_C_Cw_u <- DC_L_C_Cw_u %>%
    dplyr::mutate(C_unit = replace(C_unit, is.na(C_unit), 0))



### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - LIVE ONLY
final_DC_L_C_Cw_u <- as.data.table(subset(DC_L_C_Cw_u, timestep == 26))

final_DC_field_L_C_Cw <- subset(DC_field_L_C_Cw, timestep == 26)

final_DC_L_C_Cw_u <- merge(final_DC_L_C_Cw_u, final_DC_field_L_C_Cw, by = c("Unit", "Treatment", "timestep"))
names(final_DC_L_C_Cw_u)[names(final_DC_L_C_Cw_u) == "C_unit.x"] <- "C_unit"
names(final_DC_L_C_Cw_u)[names(final_DC_L_C_Cw_u) == "C_unit.y"] <- "field_C"

DC_L_Cw_rss <- with(final_DC_L_C_Cw_u, sum((C_unit - field_C)^2))
DC_L_Cw_rmse <- with(final_DC_L_C_Cw_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
DC_L_C_Cw_u_mod <- subset(DC_L_C_Cw_u, timestep == 0 | timestep ==  1 | timestep == 18 | timestep == 26) # mod = model

DC_L_C_Cw_u_mod <- as.data.table(merge(DC_L_C_Cw_u_mod, DC_field_L_C_Cw, by = c("Unit", "Treatment", "timestep"))) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 - we don't want them to be zeros, they just weren't measured

names(DC_L_C_Cw_u_mod)[names(DC_L_C_Cw_u_mod) == "C_unit.x"] <- "sortie"
names(DC_L_C_Cw_u_mod)[names(DC_L_C_Cw_u_mod) == "C_unit.y"] <- "field"

DC_L_C_Cw_u_mod2 <- melt(DC_L_C_Cw_u_mod, id.vars = c("Unit", "Treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(DC_L_C_Cw_u_mod2)[names(DC_L_C_Cw_u_mod2) == "variable"] <- "DataSource"
names(DC_L_C_Cw_u_mod2)[names(DC_L_C_Cw_u_mod2) == "value"] <- "C_unit"

DC_L_C_Cw_u_mod2 <- DC_L_C_Cw_u_mod2 %>%
  mutate(unit = as.character(Unit))

# Basic linear model
DC_L_C_Cw_lm <- lm(C_unit ~ DataSource, DC_L_C_Cw_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(DC_L_C_Cw_lm)

# Mixed effects models
DC_L_C_Cw_lmer <- lmer(C_unit ~ DataSource * Treatment + (1|Unit/timestep), DC_L_C_Cw_u_mod2) # Gets singular warning!!! Needs adjusting - LW (sept12 22)
summary(DC_L_C_Cw_lmer)



# Plot all timesteps at once - observed vs. predicted
png("./Figures/DC_alltime_L_C_Cw.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(DC_L_C_Cw_u_mod, aes(x = field, y = sortie, shape = Treatment, color = Treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(Treatment), shape = factor(Treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 75, by = 15), limits = c(0, 75)) +
  scale_y_continuous(breaks = seq(0, 75, by = 15), limits = c(0, 75)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(17, 16, 18, 15),
                     breaks = c("CC", "HR", "LR", "NH"), 
                     labels = c("CC", "HR", "LR", "NH")) +
  scale_colour_manual(values = c("#F8766D", "#00BFC4", "#7CAE00", "#C77CFF"), 
                      breaks = c("CC", "HR", "LR", "NH"), 
                      labels = c("CC", "HR", "LR", "NH"))

dev.off()



##### Western hemlock #####

DC_L_C_Hw <- subset(DC_L_C, DC_L_C$Species == "Hw")

# Recalculate C per plot for hemlock only
DC_L_C_Hw_p <- DC_L_C_Hw %>% 
  dplyr::group_by(timestep, Unit, PlotNumber) %>% 
  dplyr::mutate(C_plot = sum(C_tree, na.rm = TRUE))

# Select desired columns
DC_L_C_Hw_p <- DC_L_C_Hw_p %>% 
  dplyr::select(timestep, Unit, PlotNumber, C_plot, Treatment, count)

DC_L_C_Hw_p <- unique(DC_L_C_Hw_p)

# Calculate carbon per unit by averaging carbon per plot
DC_L_C_Hw_u <- DC_L_C_Hw_p %>% 
  dplyr::group_by(timestep, Unit) %>% 
  dplyr::mutate(C_unit = sum(C_plot, na.rm = TRUE)/count)

# Select desired columns
DC_L_C_Hw_u <- DC_L_C_Hw_u %>% 
  dplyr::select(timestep, Unit, C_unit, Treatment)

DC_L_C_Hw_u <- unique(DC_L_C_Hw_u)



# Merge with labels, so all timesteps have a C_unit (including zeros)
DC_L_C_Hw_u <- merge(DC_L_C_Hw_u, DC.labels, by = c("Unit", "timestep"), all.y = TRUE)

DC_L_C_Hw_u$Treatment.x <- NULL

names(DC_L_C_Hw_u)[names(DC_L_C_Hw_u) == "Treatment.y"] <- "Treatment"

DC_L_C_Hw_u <- DC_L_C_Hw_u %>%
    dplyr::mutate(C_unit = replace(C_unit, is.na(C_unit), 0))



### RSS and RMSE ###

# Compare final year of simulation C to final year of field data C - LIVE ONLY
final_DC_L_C_Hw_u <- as.data.table(subset(DC_L_C_Hw_u, timestep == 26))

final_DC_field_L_C_Hw <- subset(DC_field_L_C_Hw, timestep == 26)

final_DC_L_C_Hw_u <- merge(final_DC_L_C_Hw_u, final_DC_field_L_C_Hw, by = c("Unit", "Treatment", "timestep"))
names(final_DC_L_C_Hw_u)[names(final_DC_L_C_Hw_u) == "C_unit.x"] <- "C_unit"
names(final_DC_L_C_Hw_u)[names(final_DC_L_C_Hw_u) == "C_unit.y"] <- "field_C"

DC_L_Hw_rss <- with(final_DC_L_C_Hw_u, sum((C_unit - field_C)^2))
DC_L_Hw_rmse <- with(final_DC_L_C_Hw_u, sqrt(mean((C_unit - field_C)^2)))



### Linear and mixed effects models ###

# Data manipulation
DC_L_C_Hw_u_mod <- subset(DC_L_C_Hw_u, timestep == 0 | timestep ==  1 | timestep == 18 | timestep == 26) # mod = model

DC_L_C_Hw_u_mod <- as.data.table(merge(DC_L_C_Hw_u_mod, DC_field_L_C_Hw, by = c("Unit", "Treatment", "timestep"))) # okay that this data frame has 85 observations instead of 93 - the missing observations are because units 16-19 were not measured in years 2 and 5 - we don't want them to be zeros, they just weren't measured

names(DC_L_C_Hw_u_mod)[names(DC_L_C_Hw_u_mod) == "C_unit.x"] <- "sortie"
names(DC_L_C_Hw_u_mod)[names(DC_L_C_Hw_u_mod) == "C_unit.y"] <- "field"

DC_L_C_Hw_u_mod2 <- melt(DC_L_C_Hw_u_mod, id.vars = c("Unit", "Treatment", "timestep"), measure.vars = c("sortie", "field")) # Should be 170 observations
names(DC_L_C_Hw_u_mod2)[names(DC_L_C_Hw_u_mod2) == "variable"] <- "DataSource"
names(DC_L_C_Hw_u_mod2)[names(DC_L_C_Hw_u_mod2) == "value"] <- "C_unit"

DC_L_C_Hw_u_mod2 <- DC_L_C_Hw_u_mod2 %>%
  mutate(unit = as.character(Unit))

# Basic linear model
DC_L_C_Hw_lm <- lm(C_unit ~ DataSource, DC_L_C_Hw_u_mod2) # does not force the intercept through zero, tells us the difference between the two means
summary(DC_L_C_Hw_lm)

# Mixed effects models
DC_L_C_Hw_lmer <- lmer(C_unit ~ DataSource * Treatment + (1|Unit/timestep), DC_L_C_Hw_u_mod2) # Gets singular warning!!! Needs adjusting - LW (sept12 22)
summary(DC_L_C_Hw_lmer)



# Plot all timesteps at once - observed vs. predicted
png("./Figures/DC_alltime_L_C_Hw.png", width=700, height=500, units="px", pointsize=23, antialias="default")

ggplot(DC_L_C_Hw_u_mod, aes(x = field, y = sortie, shape = Treatment, color = Treatment)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"), 
        axis.text = element_text(size = 15), 
        axis.title = element_text(size = 18), 
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 17)) +
  geom_point(aes(colour = factor(Treatment), shape = factor(Treatment)), size = 2) +
  geom_abline() +
  scale_x_continuous(breaks = seq(0, 261, by = 20), limits = c(0, 261)) +
  scale_y_continuous(breaks = seq(0, 261, by = 20), limits = c(0, 261)) +
  labs(x = "Observed Carbon (Mg/ha)", y = "Predicted Carbon (Mg/ha)", col = "Treatment", shape = "Treatment") +
  scale_shape_manual(values = c(17, 16, 18, 15),
                     breaks = c("CC", "HR", "LR", "NH"), 
                     labels = c("CC", "HR", "LR", "NH")) +
  scale_colour_manual(values = c("#F8766D", "#00BFC4", "#7CAE00", "#C77CFF"), 
                      breaks = c("CC", "HR", "LR", "NH"), 
                      labels = c("CC", "HR", "LR", "NH"))

dev.off()

```







